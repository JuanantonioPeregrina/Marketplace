
<%- include("partials/header", {}) -%>
<script>
    var user = JSON.parse('<%- JSON.stringify(user || {}) %>');
    console.log("Usuario cargado en cliente:", user);
</script>



<script src="/js/subasta.js"></script>
<link rel="stylesheet" href="/css/styleA.css">

<main class="container mx-auto px-6 py-6">
    <h1 class="text-5xl font-bold text-center mb-1 text-gray-900 flex items-center justify-center">
        üè∑Ô∏è Anuncios Publicados
    </h1>


<!-- Filtros Mejorados -->
<form action="/anuncios" method="GET" class="flex flex-wrap justify-center items-center gap-2 bg-gray-100 p-3 rounded-lg shadow-sm max-w-4xl mx-auto">
        
    <select name="presupuesto" class="form-select border px-2 py-1 rounded-md text-gray-700 w-40 text-sm">
        <option value="">Presupuesto</option>
        <option value="menos-100">Menos de 100‚Ç¨</option>
        <option value="100-500">Entre 100‚Ç¨ y 500‚Ç¨</option>
        <option value="mas-500">M√°s de 500‚Ç¨</option>
    </select>

    <input type="text" name="ubicacion" placeholder="Ubicaci√≥n" 
        class="border px-2 py-1 rounded-md text-gray-700 w-40 text-sm" />

    <select name="reputacion" class="form-select border px-2 py-1 rounded-md text-gray-700 w-40 text-sm">
        <option value="">Reputaci√≥n</option>
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5 estrellas)</option>
        <option value="3-4">‚≠ê‚≠ê‚≠ê - ‚≠ê‚≠ê‚≠ê‚≠ê (3 a 4 estrellas)</option>
        <option value="menos-3">‚≠ê - ‚≠ê‚≠ê (Menos de 3 estrellas)</option>
    </select>
    <select name="estado" class="form-select border px-2 py-1 rounded-md text-gray-700 w-40 text-sm">
        <option value="" <%= !estado ? 'selected' : '' %>>Estado</option>
        <option value="activos" <%= estado === 'activos' ? 'selected' : '' %>>Activos</option>
        <option value="finalizados" <%= estado === 'finalizados' ? 'selected' : '' %>>Finalizados</option>
        <option value="en_produccion" <%= estado === 'en_produccion' ? 'selected' : '' %>>En Producci√≥n</option>
    </select>
    
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-semibold shadow-md hover:bg-blue-600 transition">
        üîç Filtrar
    </button>
</form>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <% anuncios.forEach(anuncio => { %>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 flex flex-col h-full p-6">
              

                
                         
               
                   
 <!-- Enlace al anuncio espec√≠fico -->
 <a href="/anuncios/<%= anuncio._id %>" class="block relative group">
    <div class="h-56 w-full bg-gray-200 overflow-hidden rounded-md">
      <img src="<%= anuncio.imagen %>" alt="Imagen de <%= anuncio.titulo %>" 
           class="w-full h-full object-cover transition-transform group-hover:scale-105" />
      <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
        <span class="text-white font-semibold bg-blue-600 px-3 py-1 rounded">
          üîé Ver detalles
        </span>
      </div>
    </div>
  </a>
  

<div class="p-5 flex flex-col flex-grow justify-between">
    <div>
        <h2 class="text-2xl font-semibold text-gray-900 mb-3 line-clamp-2">
            <%= anuncio.titulo %>
        </h2>
        <p class="text-gray-600 text-sm flex-grow line-clamp-3 h-16 overflow-hidden">
            <%= anuncio.descripcion %>
        </p>
        
                
                <!-- Contenedor del contador con data-inicio y data-fin -->
        <div 
        class="countdown-container mt-4" 
        id="countdown-<%= anuncio._id %>"
        data-inicio="<%= anuncio.fechaInicioSubasta ? new Date(anuncio.fechaInicioSubasta).toISOString() : '' %>"

        >

        <% 
        const ahora       = new Date();
        const expiracion  = new Date(anuncio.fechaExpiracion);
        const estaActiva  = anuncio.estadoSubasta === 'activa'  && ahora < expiracion;
        const estaPendiente = anuncio.estadoSubasta === 'pendiente' && ahora < expiracion;
        // si expiraci√≥n pasada, se considera finalizada
        const estaFinalizada = ahora >= expiracion;
        %>

        <% if (estaFinalizada) { %>
        <p class="text-red-600 font-semibold mt-2">üîö Subasta finalizada</p>
        <% } else if (estaActiva) { %>
        <p class="text-green-600 font-semibold mt-2">‚úÖ Subasta en curso</p>
        <% } else if (estaPendiente) { %>
        <p class="text-blue-500 font-semibold mt-2">üïí Subasta pendiente</p>
        <% } %>

        
        
        <div class="countdown-box">
            <div class="countdown-box-label">D√çAS</div>
            <div class="countdown-box-value" id="days-<%= anuncio._id %>">00</div>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-box">
            <div class="countdown-box-label">HORAS</div>
            <div class="countdown-box-value" id="hours-<%= anuncio._id %>">00</div>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-box">
            <div class="countdown-box-label">MINUTOS</div>
            <div class="countdown-box-value" id="minutes-<%= anuncio._id %>">00</div>
        </div>
        <span class="countdown-separator">:</span>
        <div class="countdown-box">
            <div class="countdown-box-label">SEGUNDOS</div>
            <div class="countdown-box-value" id="seconds-<%= anuncio._id %>">00</div>
        </div>
        </div>

                 

  
                        <p class="text-green-600 text-xl font-bold mt-4 flex items-center">
                            üí∞ ‚Ç¨<%= anuncio.precio %>
                        </p>

                        <div class="mt-3 text-gray-500 text-sm flex items-center">
                            <span class="mr-2">üìå Publicado por:</span> <strong><%= anuncio.autor %></strong>
                        </div>
                        <div class="mt-3 text-gray-500 text-sm flex items-center">
                            <span class="mr-2">üìå Ubicaci√≥n:</span> <strong><%= anuncio.ubicacion %></strong>
                        </div>
                        
                          
  
                        
                    </div>

                    <!-- Bot√≥n de chat para inscritos -->
                    <% if (user && user.username !== anuncio.autor && Array.isArray(anuncio.inscritos) && anuncio.inscritos.includes(user.username)) { %>

                        <div class="mt-6 flex justify-center">
                            <% if (anuncio.chatIniciado) { %>
                                <a href="/chat?anuncioId=<%= anuncio._id %>&usuario=<%= anuncio.autor %>" 
                                    class="block text-center bg-blue-600 text-white no-underline px-5 py-3 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition w-full">
                                    üí¨ Ir al chat
                                </a>
                            <% } else { %>
                                <button class="block text-center bg-gray-400 text-white px-5 py-3 rounded-lg opacity-70 cursor-not-allowed w-full">
                                    ‚è≥ Esperando conversaci√≥n
                                </button>
                            <% } %>
                        </div>
                    <% } %>
                        
                    <!-- Lista de inscritos con bot√≥n de chat -->
                    <% if (user && user.username === anuncio.autor) { %>
                        

                        <div class="mt-6">
                            <h4 class="text-md font-semibold text-gray-800 mb-3">üìå Usuarios inscritos:</h4>
                            <ul class="space-y-3">
                                <% if (anuncio.inscritos && anuncio.inscritos.length > 0) { %>

                                    <% anuncio.inscritos.forEach(inscrito => { %>
                                        <li class="flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm">
                                            <span class="text-gray-700 font-medium"><%= inscrito %></span>
                                            <a href="/chat?anuncioId=<%= anuncio._id %>&usuario=<%= inscrito %>" 
                                                class="bg-blue-500 no-underline text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition text-sm flex items-center">
                                                üí¨ Chatear
                                            </a>
                                        </li>
                                    <% }); %>
                                <% } else { %>
                                    <p class="text-gray-400 text-sm">No hay usuarios inscritos todav√≠a.</p>
                                <% } %>
                            </ul>
                        </div>              
                        
                    <% } %>

                    <% if (user) { %>
                        <!-- Bot√≥n de favoritos -->
                        <form action="/favoritos/<%= anuncio._id %>" method="POST">
                            <button type="submit" class="favorite-btn <%= anuncio.esFavorito ? 'favorito' : '' %>">
                              <!-- Coraz√≥n vac√≠o -->
                              <svg class="empty" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path fill="none" d="M0 0H24V24H0z"></path>
                                <path d="M16.5 3C19.538 3 22 5.5 22 9c0 7-7.5 11-10 12.5C9.5 20 2 16 2 9c0-3.5 
                                                          2.5-6 5.5-6C9.36 3 11 4 12 5c1-1 2.64-2 4.5-2zm-3.566 15.604c.881-.556 
                                                          1.676-1.109 2.42-1.701C18.335 14.533 20 11.943 20 9c0-2.36-1.537-4-3.5-4-1.076 
                                                          0-2.24.57-3.086 1.414L12 7.828l-1.414-1.414C9.74 5.57 8.576 5 7.5 5 5.56 5 
                                                          4 6.656 4 9c0 2.944 1.666 5.533 4.645 7.903.745.592 1.54 1.145 2.421 
                                                          1.7.299.189.595.37.934.572.339-.202.635-.383.934-.571z"></path>
                              </svg>
                          
                              <!-- Coraz√≥n lleno -->
                              <svg class="filled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path fill="none" d="M0 0H24V24H0z"></path>
                                <path fill="#ff4b4b" d="M16.5 3C19.538 3 22 5.5 22 9c0 7-7.5 11-10 
                                                          12.5C9.5 20 2 16 2 9c0-3.5 2.5-6 5.5-6C9.36 3 11 4 
                                                          12 5c1-1 2.64-2 4.5-2z"></path>
                              </svg>
                            </button>
                          </form>
                          
                    
        
                    
                
                    <% } else { %>
                        <p class="text-red-500 text-sm font-bold mt-2">Debe iniciar sesi√≥n para pujar.</p>
                    <% } %>
                    <a href="/anuncios/<%= anuncio._id %>"
                                     class="mt-2 text-blue-500 hover:underline text-sm font-medium inline-block text-center">
                                     Click aqu√≠ para m√°s detalles
                                    </a>    

                    <!-- Pujar manualmente 
                    <form action="/anuncios/pujar/<%= anuncio._id %>" method="POST">

                        <input type="number" name="precio" required>
                        <button class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold">üî• Pujar</button>
                    </form> -->
                    
                   
                    
                    <!-- üî• Mensaje de √©xito (inicialmente oculto) -->
                    <div id="mensaje-oferta-automatica-<%= anuncio._id %>" class="hidden bg-blue-500 text-white p-2 rounded mt-2">
                        ‚úÖ Oferta autom√°tica registrada con √©xito
                    </div>
                    
                    
                    
                    <!-- Bot√≥n de inscripci√≥n -->
<% if (user && user.username !== anuncio.autor) { %>
    <div class="text-center mt-4">
        <% if (user && user.username !== anuncio.autor && anuncio.inscritos && Array.isArray(anuncio.inscritos) && anuncio.inscritos.includes(user.username)) { %>

            <button class="px-4 py-2 bg-gray-500 text-white rounded cursor-not-allowed" disabled>
                Inscrito
            </button>
        <% } else { %>
            <button onclick="inscribirse('<%= anuncio._id %>')" class="px-4 py-2 bg-green-500 text-white rounded">
                Inscribirme
            </button>
        <% } %>
    </div>
    <% } else if (user && user.username === anuncio.autor) { %>
        <p class="text-gray-500 mt-2">Eres el autor de este anuncio.</p>
        <div class="mt-4 flex gap-2">
            <!-- Bot√≥n de editar -->
            <button 
                class="bg-yellow-500 text-white px-4 py-2 rounded-md text-sm font-semibold shadow-md hover:bg-yellow-600 transition edit-btn"
                data-id="<%= anuncio._id %>"
                data-titulo="<%= anuncio.titulo %>"
                data-descripcion="<%= anuncio.descripcion %>"
                data-precio="<%= anuncio.precioActual %>"
            >
                ‚úèÔ∏è Editar
            </button>
    
            <!-- Bot√≥n de eliminar -->
            <button 
                class="bg-red-500 text-white px-4 py-2 rounded-md text-sm font-semibold shadow-md hover:bg-red-600 transition delete-btn"
                data-id="<%= anuncio._id %>"
            >
                üóëÔ∏è Eliminar
            </button>
        </div>
        <!-- Modal de Edici√≥n -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-lg font-bold mb-4">Editar Anuncio</h2>
        <form id="editForm">
            <input type="hidden" id="editAnuncioId">
            
            <label class="block mb-2">T√≠tulo:</label>
            <input type="text" id="editTitulo" class="w-full border p-2 rounded mb-3" required>

            <label class="block mb-2">Descripci√≥n:</label>
            <textarea id="editDescripcion" class="w-full border p-2 rounded mb-3" required></textarea>

            <label class="block mb-2">Precio:</label>
            <input type="number" id="editPrecio" class="w-full border p-2 rounded mb-3" required>

            <div class="flex justify-end gap-2">
                <button type="button" id="cancelEdit" class="bg-gray-400 px-4 py-2 rounded text-white">Cancelar</button>
                <button type="submit" class="bg-blue-500 px-4 py-2 rounded text-white">Guardar</button>
            </div>
        </form>
    </div>
</div>

    <% } %>
    

                </div>
            </div>
        <% }); %>
    </div>

    <!-- paginaci√≥n mejorada -->
    <nav class="mt-8 flex justify-center">
        <ul class="inline-flex -space-x-px">
          <% for(let i = 1; i <= totalPages; i++) { %>
            <li>
              <a
                href="/anuncios?<%= buildQuery(i) %>"
                class="px-3 py-1 border <%= page===i ? 'bg-blue-500 text-white' : 'bg-white text-gray-700' %> hover:bg-blue-100"
              >
                <%= i %>
              </a>
            </li>
          <% } %>
        </ul>
      </nav>
    

</main>

<%
// Funci√≥n que toma un n√∫mero de p√°gina y devuelve
// "presupuesto=...&ubicacion=...&estado=...&page=X"
function buildQuery(pageNum) {
  const qs = [];
  if (filtros.presupuesto)  qs.push('presupuesto='  + encodeURIComponent(filtros.presupuesto));
  if (filtros.ubicacion)    qs.push('ubicacion='    + encodeURIComponent(filtros.ubicacion));
  if (filtros.reputacion)   qs.push('reputacion='   + encodeURIComponent(filtros.reputacion));
  if (filtros.estado)       qs.push('estado='       + encodeURIComponent(filtros.estado));
  qs.push('page=' + pageNum);
  return qs.join('&');
}
%>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/countdown.js"></script>

<script>
    var user = JSON.parse('<%- JSON.stringify(user || {}) %>');
    var apiKey = "<%= apiKey ? apiKey : '' %>";

    if (apiKey && apiKey !== "null" && apiKey !== "undefined") {
        localStorage.setItem("apiKey", apiKey);
        console.log("‚úÖ API Key guardada en localStorage:", apiKey);
    } else {
        console.warn("‚ö†Ô∏è API Key no disponible en la sesi√≥n.");
    }

    document.addEventListener("DOMContentLoaded", function () {
        const socket = io();

        // Interceptar formularios de oferta autom√°tica
        document.querySelectorAll('[id^="oferta-automatica-form-"]').forEach(form => {
            form.addEventListener("submit", function (event) {
                event.preventDefault();
                
                const formData = new FormData(form);
                const anuncioId = form.id.replace("oferta-automatica-form-", "");
                const mensajeDiv = document.getElementById(`mensaje-oferta-automatica-${anuncioId}`);

                fetch(`/anuncios/oferta-automatica/${anuncioId}`, {
                    method: "POST",
                    body: new URLSearchParams(formData),
                    headers: { "Content-Type": "application/x-www-form-urlencoded" }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.mensaje) {
                        mensajeDiv.innerText = "‚úÖ " + data.mensaje;
                        mensajeDiv.classList.remove("hidden");
                        setTimeout(() => mensajeDiv.classList.add("hidden"), 3000);
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        });

        // Actualizaci√≥n de subasta
        socket.on("actualizar_subasta", (data) => {
            console.log("üì¢ Actualizaci√≥n recibida:", data);

            const { anuncioId, precioActual, tiempoRestante } = data;
            const precioElement = document.getElementById(`precio-${anuncioId}`);
            const timerElement = document.getElementById(`timer-${anuncioId}`);

            if (precioElement) precioElement.innerText = `‚Ç¨${precioActual}`;

            if (timerElement) {
                if (!isNaN(tiempoRestante) && tiempoRestante >= 0) {
                    const minutos = Math.floor(tiempoRestante / 60);
                    const segundos = tiempoRestante % 60;
                    timerElement.innerText = `${minutos}:${segundos < 10 ? '0' : ''}${segundos}`;
                } else {
                    timerElement.innerText = "00:00";
                }
            }
        });

        // Subasta finalizada
        socket.on("subasta_finalizada", (data) => {
            alert(`La subasta del anuncio ${data.anuncioId} ha finalizado con un precio de ‚Ç¨${data.precioFinal}`);
        });

        // Cuenta regresiva
        document.querySelectorAll('.countdown-container').forEach(container => {
            const id = container.id.replace('countdown-', '');
            const fechaInicio = container.getAttribute('data-inicio');

            // üîπ Solo pasamos fechaInicio
            if (fechaInicio) {
                iniciarCuentaRegresiva(id, fechaInicio);
            }
        });

        // Edici√≥n de anuncio
        const editModal = document.getElementById("editModal");
        const editForm = document.getElementById("editForm");
        const editAnuncioId = document.getElementById("editAnuncioId");
        const editTitulo = document.getElementById("editTitulo");
        const editDescripcion = document.getElementById("editDescripcion");
        const editPrecio = document.getElementById("editPrecio");
        const cancelEdit = document.getElementById("cancelEdit");

        let userApiKey = localStorage.getItem("apiKey") || "";

        document.querySelectorAll(".edit-btn").forEach(button => {
            button.addEventListener("click", function () {
                editAnuncioId.value = this.dataset.id;
                editTitulo.value = this.dataset.titulo;
                editDescripcion.value = this.dataset.descripcion;
                editPrecio.value = this.dataset.precio;
                editModal.classList.remove("hidden");
            });
        });

        cancelEdit.addEventListener("click", function () {
            editModal.classList.add("hidden");
        });

        editForm.addEventListener("submit", async function (event) {
            event.preventDefault();
            const id = editAnuncioId.value;
            const updatedData = {
                titulo: editTitulo.value,
                descripcion: editDescripcion.value,
                precioActual: Number(editPrecio.value)
            };

            try {
                const response = await fetch(`/api/anuncios/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": userApiKey
                    },
                    body: JSON.stringify(updatedData)
                });

                const result = await response.json();
                console.log("üîç Respuesta de actualizaci√≥n:", result);

                if (result.success) {
                    alert("‚úÖ Anuncio actualizado correctamente");
                    location.reload();
                } else {
                    alert("‚ùå Error al actualizar el anuncio: " + result.error);
                }
            } catch (error) {
                console.error("‚ùå Error en la actualizaci√≥n:", error);
                alert("‚ùå Error al actualizar el anuncio.");
            }
        });

        // Eliminar anuncio
        function attachDeleteEventListeners() {
            console.log("üì¢ Registrando eventos de eliminaci√≥n...");
            document.querySelectorAll(".delete-btn").forEach(button => {
                button.addEventListener("click", async function (event) {
                    event.preventDefault();
                    const id = this.dataset.id;
                    console.log(`üóëÔ∏è Intentando eliminar anuncio con ID: ${id}`);

                    if (!id) {
                        console.error("‚ö†Ô∏è No se encontr√≥ un ID de anuncio.");
                        return;
                    }

                    if (confirm("‚ùó¬øEst√°s seguro de que quieres eliminar este anuncio?")) {
                        try {
                            const response = await fetch(`/api/anuncios/${id}`, {
                                method: "DELETE",
                                headers: {
                                    "Content-Type": "application/json",
                                    "x-api-key": localStorage.getItem("apiKey") || ""
                                }
                            });

                            const result = await response.json();
                            console.log("üîç Respuesta del servidor:", result);

                            if (response.ok && result.success) {
                                alert("‚úÖ Anuncio eliminado correctamente");

                                const anuncioElemento = document.querySelector(`button[data-id='${id}']`)?.closest(".anuncio-container");
                                if (anuncioElemento) {
                                    anuncioElemento.remove();
                                } else {
                                    console.warn("‚ö†Ô∏è No se encontr√≥ el contenedor del anuncio en el DOM.");
                                }
                            } else {
                                throw new Error(result.error || "Error desconocido");
                            }
                        } catch (error) {
                            console.error("‚ùå Error en la eliminaci√≥n:", error);
                            alert(`‚ùå Error al eliminar el anuncio: ${error.message}`);
                        }
                    }
                });
            });
        }

        // Esperar un segundo antes de adjuntar eventos
        setTimeout(attachDeleteEventListeners, 1000);
    });
</script>


<%- include("partials/footer") %>
