<%- include("partials/header", {}) %>

<link rel="stylesheet" href="/css/soporte-whats.css">

<div class="chat-wrapper">
  <!-- Lista de chats -->
  <aside class="chat-sidebar">
    <h2>Chats</h2>
  
    <% if (user?.rol === 'admin') { %>
      <ul id="admin-chats" class="chat-list"></ul>
    <% } else { %>
      <ul class="chat-list">
        <% chats.forEach(chat => { %>
          <li onclick="location.href='/soporte/<%= chat._id %>'">
            <div class="chat-user">
              <img src="/images/avatar.webp" class="avatar" />
              <div class="chat-info">
                <strong><%= chat.nombre %></strong>
                <p><%= chat.ultimoMensaje %></p>
              </div>
              <div class="chat-meta">
                <span class="fecha"><%= chat.fecha %></span>
              </div>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </aside>
  <% if (user?.rol === 'admin') { %>
    <aside class="admin-chat-sidebar">
      <h3>Usuarios activos</h3>
      <ul id="active-guests" class="admin-users-list">
        <!-- Se llenar치 din치micamente con JS -->
      </ul>
    </aside>
  <% } %>
  

  <!-- Panel de conversaci칩n -->
  <main class="chat-main">
    <% if (conversacion) { %>
      <div class="chat-header">
        <h3><%= conversacion.nombre %></h3>
      </div>

      <ul id="chat-mensajes" class="chat-messages">
        <% conversacion.mensajes.forEach(msg => { %>
          <li class="<%= msg.remitente === user.username ? 'msg-self' : 'msg-other' %>">
            <div class="bubble"><%= msg.contenido %> <span class="hora"><%= new Date(msg.fecha).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></span></div>
          </li>
        <% }) %>
      </ul>

      <form id="chat-form" class="chat-form">
        <input type="text" name="contenido" placeholder="Escribe tu mensaje..." required>
        <button>Enviar</button>
      </form>
    <% } else { %>
      <div class="chat-placeholder">
        <p>Selecciona una conversaci칩n para empezar</p>
      </div>
    <% } %>
  </main>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="/js/soporte-chat.js"></script>

<%- include("partials/footer") %>
